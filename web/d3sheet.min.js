!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.d3sheet=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){!function(){function rescale(){var trans=d3.event.translate,scale=d3.event.scale;d3sheet.svg.attr("transform","translate("+trans+") scale("+scale+")")}function applyCss(css){if(null!=css){var selectors=Object.keys(css);$.each(selectors,function(i,selector){var elements={};elements="#"==selector.slice(0,1)?$(selector):$("."+selector);var properties=Object.keys(css[selector]);$.each(properties,function(j,property){elements.css(property,css[selector][property])})})}}function checkRequirements(){if("undefined"==typeof d3)throw new Error("D3 library not found!");if("undefined"==typeof $)throw new Error("jQuery not found!")}checkRequirements();var d3sheet={ver:"1.0.0",svgContainerId:"",infoContainerId:"",svg:{},spreadsheet:{},model:{}};module.exports=d3sheet,d3sheet.init=function(svgContainerId,infoContainerId){null==svgContainerId&&(svgContainerId="d3sheet-svg"),d3sheet.svgContainerId=svgContainerId,null==infoContainerId&&(infoContainerId="d3sheet-info"),d3sheet.infoContainerId=infoContainerId;var svgContainer=$("#"+svgContainerId),width=svgContainer.width(),height=svgContainer.height(),zoom=d3.behavior.zoom().on("zoom",rescale),svg=d3.select("#"+svgContainerId).append("svg").attr("width","100%").attr("height","100%"),defs=svg.append("defs");defs.append("marker").attr("class","link").attr("id","markerEnd").attr("viewBox","0 0 30 20").attr("refX",58).attr("refY",10).attr("markerWidth",20).attr("markerHeight",30).attr("orient","auto").append("path").attr("d","M 0 0 L 30 10 L 0 20"),defs.append("marker").attr("class","link").attr("id","markerStart").attr("viewBox","0 0 30 20").attr("refX",-30).attr("refY",10).attr("markerWidth",20).attr("markerHeight",30).attr("orient","auto").append("path").attr("d","M 30 0 L 0 10 L 30 20"),svg=svg.append("g").call(zoom);svg.append("rect").attr("width",width).attr("height",height).style("fill","none").style("pointer-events","all");return d3sheet.svg=svg.append("g"),d3.select("#"+infoContainerId).append("div"),d3sheet},d3sheet.load=function(spreadsheetKey){var spreadsheet=require("./spreadsheet");spreadsheet(spreadsheetKey,function(spreadsheet){console.log(spreadsheet),d3sheet.spreadsheet=spreadsheet,document.title=spreadsheet.title;var infoModule=require("./info"),info=infoModule(d3sheet.infoContainerId,spreadsheet.title),modelModule=require("./model");d3sheet.model=modelModule(d3sheet.spreadsheet),console.log(d3sheet.model);var graphModule=require("./graph");d3sheet.graph=graphModule(d3sheet.model),console.log(d3sheet.graph);var forceModule=require("./force");forceModule(d3sheet.graph,d3sheet.svgContainerId,d3sheet.svg,info,d3sheet.model.settings);applyCss(d3sheet.model.settings.css)})}}()},{"./force":2,"./graph":3,"./info":4,"./model":5,"./spreadsheet":6}],2:[function(require,module,exports){module.exports=function(graph,svgContainerId,svg,info,settings){function dragstarted(d){d3.event.sourceEvent.stopPropagation(),d3.select(this).classed("dragging",!0)}function dragged(d){d3.select(this).attr("cx",d.x=d3.event.x).attr("cy",d.y=d3.event.y)}function dragended(d){d3.select(this).classed("dragging",!1)}function restart(){svg.selectAll(".link").data(graph.links).enter().append("path").attr("class","link").attr("marker-end",linkMarkerEnd).attr("marker-start",linkMarkerStart),svg.selectAll(".link-label").data(graph.links).enter().append("text").text(function(graphLink){return graphLink.label}).attr("class","link-label").attr("text-anchor","middle"),svg.selectAll(".node").data(graph.nodes).enter().append("circle").attr("class",nodeClass).attr("r",20).attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}).attr("fill",nodeFillColor).call(force.drag).on("click",nodeClick),svg.selectAll(".node-label").data(graph.nodes).enter().append("text").attr("class","node-label").attr("dy",".35em").attr("text-anchor","middle").text(function(graphNode){return graphNode.node.label()}).call(force.drag).on("click",nodeClick),selectAll(),force.start()}function linkMarkerEnd(graphLink){return graphLink.toTarget?"url(#markerEnd)":"none"}function linkMarkerStart(graphLink){return graphLink.toSource?"url(#markerStart)":"none"}function nodeClass(graphNode){return"node "+graphNode.node.nodeGroup.name}function nodeClick(graphNode){info.showNode(graphNode.node,nodeFillColor(graphNode))}function nodeFillColor(graphNode){return settings.css.get(graphNode.node.nodeGroup.name+".fill",colors(graphNode.node.nodeGroup.name))}function selectAll(){node=svg.selectAll(".node"),nodeLabel=svg.selectAll(".node-label"),link=svg.selectAll(".link"),linkLabel=svg.selectAll(".link-label")}function onTick(){link.attr("d",linkArc),linkLabel.attr("x",function(d){return(d.source.x+d.target.x)/2}).attr("y",function(d){return(d.source.y+d.target.y)/2}),node.attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}),nodeLabel.attr("x",function(d){return d.x}).attr("y",function(d){return d.y})}function linkArc(d){d.target.x-d.source.x,d.target.y-d.source.y;return"M"+d.source.x+" "+d.source.y+"L "+d.target.x+","+d.target.y}var node=[],nodeLabel=[],link=[],linkLabel=[],colors=d3.scale.category20(),svgContainer=$("#"+svgContainerId),width=svgContainer.width(),height=svgContainer.height();selectAll();var force=d3.layout.force().size([width,height]).linkDistance(170).charge(-5e3).gravity(.3).nodes(graph.nodes).links(graph.links).on("tick",onTick);force.drag().origin(function(d){return d}).on("dragstart",dragstarted).on("drag",dragged).on("dragend",dragended);return this.restart=restart,restart(),this}},{}],3:[function(require,module,exports){function Graph(){return this.nodes=[],this.links=[],this}function GraphNode(node){return this.node=node,this}function GraphLink(source,target,label,toTarget,toSource){return this.source=source,this.target=target,this.label=label,this.toSource=toSource,this.toTarget=toTarget,this}module.exports=function(model){function getGraphNode(node){var result=null;return $.each(graph.nodes,function(i,graphNode){return graphNode.node==node?(result=graphNode,!1):void 0}),result}var graph=new Graph;return $.each(model.nodeGroups.items,function(i,nodeGroup){$.each(nodeGroup.nodes,function(j,node){var graphNode=new GraphNode(node);graph.nodes.push(graphNode)})}),$.each(graph.nodes,function(i,graphNode){$.each(graphNode.node.refs,function(j,ref){graph.links.push(new GraphLink(graphNode,getGraphNode(ref.targetNode),ref.label,ref.toTarget,ref.toSource))})}),graph}},{}],4:[function(require,module,exports){module.exports=function(infoContainerId,title){return $("#"+infoContainerId+" h1").text(title),this.showNode=function(node,fillColor){function addProperty(name,value){ul.append('<li><span class="d3sheet-node-property-name">'+name+':</span> <span class="d3sheet-node-property-value">'+formatValue(value)+"</span></li>")}function formatValue(value){return"http"==value.slice(0,"4").toLowerCase()?'<a href="'+value+'">'+value+"</a>":value}$("#d3sheet-node-info h2").text(node.heading()),$("#d3sheet-node-info header").css("background-color",fillColor),$("#d3sheet-node-sheet-name").text(node.nodeGroup.name);var ul=$("#d3sheet-node-properties");ul.empty(),$.each(node.properties,function(i,nodeProperty){nodeProperty.isHidden||addProperty(nodeProperty.name,nodeProperty.value)});var groupedLinks={};$.each(node.refs,function(i,ref){var linkName=ref.targetNode.nodeGroup.name;null==groupedLinks[linkName]&&(groupedLinks[linkName]=[]),groupedLinks[linkName].push(ref.targetNode.heading())});var linkNames=Object.keys(groupedLinks);$.each(linkNames,function(i,linkName){addProperty(linkName,groupedLinks[linkName].join(", "))})},this}},{}],5:[function(require,module,exports){function Model(){return this.nodeGroups=new NodeGroups,this.settings={},this}function NodeGroups(){return this.items=[],this}function NodeGroup(name,labelPropertyName){return this.name=name,this.labelPropertyName=labelPropertyName,this.nodes=[],this}function Node(properties,nodeGroup){return this.properties=properties,this.refs=[],this.nodeGroup=nodeGroup,this}function NodeProperty(name,value){return this.name=name.replace("*","").replace("#",""),this.value=value,this.isHeading="*"==name.slice(0,1),this.isHidden="#"==name.slice(0,1),this}function Ref(targetNode,label,toTarget,toSource){return this.targetNode=targetNode,this.label=label,this.toTarget=toTarget,this.toSource=toSource,this}function Settings(){return this}module.exports=function(spreadsheet){function getSettings(settingsSheet){var settings=new Settings;return $.each(settingsSheet.rows,function(i,row){var key=row.rowCells[0].value,value=row.rowCells[1].value;if(null!=key&&null!=value){var path=key.split("."),current=settings;$.each(path,function(j,k){null==current[k]&&(j==path.length-1?current[k]=value:current[k]=new Settings),current=current[k]})}}),settings}function getNodeGroups(spreadsheet,nodeGroupNames,refSheetNames){function createSheetRefs(nodeGroups,refSheet,refSheetName){refSheet.header();$.each(refSheet.rows,function(i,row){if(0!=i){var source=getRefToNodeGroup(nodeGroups,refSheet,row,refSheetName.source),target=getRefToNodeGroup(nodeGroups,refSheet,row,refSheetName.target);if(null!=source&&null!=target){var label=target.label;null!=target.label&&""!=target.label||0!=row.rowCells[0].colIndex||(label=row.rowCells[0].value),$.each(source.nodes,function(j,sourceRef){$.each(target.nodes,function(k,targetRef){sourceRef.targetNode.refs.push(new Ref(targetRef.targetNode,label))})})}}})}function getRefToNodeGroup(nodeGroups,sheet,row,nodeGroupName){var result=null,colNames=sheet.header();return $.each(colNames,function(j,colName){var value=sheet.value(row,colName);if(null!=value){var refTarget=parseColumnRefName(colName,nodeGroups);return null!=refTarget&&refTarget.nodeGroup.name==nodeGroupName?(result=refTarget,result.nodes=[],$.each(refTarget.nodeGroup.nodes,function(k,targetNode){value.indexOf(targetNode.value(refTarget.propertyName))>-1&&result.nodes.push(new Ref(targetNode,refTarget.label,refTarget.toTarget,refTarget.toSource))}),!1):void 0}}),result}function createRefs(nodeGroups,nodeSheet,nodeGroup){var colNames=nodeSheet.header();$.each(nodeSheet.rows,function(i,row){0!=i&&$.each(colNames,function(j,colName){var value=nodeSheet.value(row,colName);if(null!=value){var refTarget=parseColumnRefName(colName,nodeGroups);null!=refTarget&&$.each(refTarget.nodeGroup.nodes,function(k,targetNode){value.indexOf(targetNode.value(refTarget.propertyName))>-1&&nodeGroup.nodes[i-1].refs.push(new Ref(targetNode,refTarget.label,refTarget.toTarget,refTarget.toSource))})}})})}function getNodes(nodeSheet,nodeGroupName){var header=nodeSheet.header(),result=new NodeGroup(nodeGroupName,header[0]);return $.each(nodeSheet.rows,function(i,row){0!=i&&result.nodes.push(new Node(getNodeProperties(row,header),result))}),result}function getNodeProperties(row,header){var nodeProperties=[];return $.each(row.rowCells,function(i,rowCell){var colName=header[rowCell.colIndex];-1==colName.indexOf(".")&&nodeProperties.push(new NodeProperty(colName,rowCell.value))}),nodeProperties}var nodeGroups=new NodeGroups;return $.each(nodeGroupNames,function(i,nodeGroupName){nodeGroups.items.push(getNodes(spreadsheet.sheets[nodeGroupName],nodeGroupName))}),$.each(nodeGroups.items,function(i,nodeGroup){createRefs(nodeGroups,spreadsheet.sheets[nodeGroup.name],nodeGroup)}),$.each(refSheetNames,function(i,refSheetName){createSheetRefs(nodeGroups,spreadsheet.sheets[refSheetName.name],refSheetName)}),nodeGroups}function getNodeGroupTypes(spreadsheet){var nodeGroupTypes={nodeGroupNames:[],refSheetNames:[],settingsGroupName:null},sheetNames=Object.keys(spreadsheet.sheets);return $.each(sheetNames,function(i,sheetName){if("settings"==sheetName)return void(nodeGroupTypes.settingsGroupName=sheetName);if("#"!=sheetName.slice(0,1)){var refSheet=parseRefSheetName(sheetName);return null!=refSheet&&sheetNames.indexOf(refSheet.source)>-1&&sheetNames.indexOf(refSheet.target)>-1?void nodeGroupTypes.refSheetNames.push(refSheet):void nodeGroupTypes.nodeGroupNames.push(sheetName)}}),nodeGroupTypes}function parseColumnRefName(colName,nodeGroups){var toTarget="->"==colName.slice(0,2),toSource="<-"==colName.slice(0,2),refNames=colName.replace("->","").replace("<-","").split("."),nodeGroup=null;if(refNames.length>0&&(nodeGroup=nodeGroups.getByName(refNames[0])),refNames.length>=2&&null!=nodeGroup){var result={nodeGroup:nodeGroup,propertyName:refNames[1],toTarget:toTarget,toSource:toSource};return 3==refNames.length&&(result.label=refNames[2]),result}return null}function parseRefSheetName(sheetName){var nodeNames=sheetName.split("-");return 2==nodeNames.length?{name:sheetName,source:nodeNames[0],target:nodeNames[1]}:null}var model=new Model,nodeGroupTypes=getNodeGroupTypes(spreadsheet);return model.nodeGroups=getNodeGroups(spreadsheet,nodeGroupTypes.nodeGroupNames,nodeGroupTypes.refSheetNames),null!=nodeGroupTypes.settingsGroupName&&(model.settings=getSettings(spreadsheet.sheets[nodeGroupTypes.settingsGroupName])),model},NodeGroups.prototype.getByName=function(nodeGroupName){var result=null;return $.each(this.items,function(i,nodeGroup){return nodeGroup.name==nodeGroupName?(result=nodeGroup,!1):void 0}),result},Node.prototype.value=function(propertyName){var result=null;return $.each(this.properties,function(i,property){return property.name==propertyName?(result=property.value,!1):void 0}),result},Node.prototype.label=function(){return this.value(this.nodeGroup.labelPropertyName)},Node.prototype.heading=function(){var result="";return $.each(this.properties,function(i,property){return property.isHeading?(result=property.value,!1):void 0}),""!=result?result:this.label()},Settings.prototype.get=function(key,defaultValue){var parts=key.split(".");return parts.length>1?null==this[parts[0]]?defaultValue:this[parts[0]].get(parts.splice(1,parts.length-1).join("."),defaultValue):null==this[key]?defaultValue:this[key]}},{}],6:[function(require,module,exports){function Spreadsheet(spreadsheetKey,title){return this.key=spreadsheetKey,this.title=title,this.sheets=new Sheets,this}function Sheets(){return this}function Sheet(){return this.rows=[],this}function Row(rowIndex){return this.rowIndex=rowIndex,this.rowCells=[],this}function RowCell(colIndex,value){return this.colIndex=colIndex,this.value=value,this}module.exports=function(spreadsheetKey,onLoaded){function loadSheets(spreadsheetKey,info){var spreadsheet=new Spreadsheet(spreadsheetKey,info.title),loadedSheetCount=0;for(i=1;i<=info.sheetCount;i++)loadSheet(spreadsheet,spreadsheetKey,i).then(function(){loadedSheetCount+=1,loadedSheetCount==info.sheetCount&&onLoaded(spreadsheet)})}function loadSheet(spreadsheet,spreadsheetKey,sheetIndex){return getSheet(spreadsheetKey,sheetIndex,function(response){var sheet=spreadsheet.sheets[response.feed.title.$t]=new Sheet;$.each(response.feed.entry,function(i,e){var index=e.gs$cell.row-1;null==sheet.rows[index]&&(sheet.rows[index]=new Row(index)),sheet.rows[index].rowCells.push(new RowCell(e.gs$cell.col-1,e.content.$t))}),$.each(sheet.rows,function(i,row){row.rowCells.sort(function(c1,c2){return c1.colIndex-c2.colIndex})})})}function getSheet(spreadsheetKey,sheetIndex,onSuccess){return $.ajax({url:"https://spreadsheets.google.com/feeds/cells/"+spreadsheetKey+"/"+sheetIndex+"/public/values?alt=json-in-script",jsonp:"callback",dataType:"jsonp",success:onSuccess})}function getSpreadsheetInfo(spreadsheetKey,onSuccess){$.ajax({url:"https://spreadsheets.google.com/feeds/worksheets/"+spreadsheetKey+"/public/full?alt=json-in-script",jsonp:"callback",dataType:"jsonp",success:function(response){var info={sheetCount:response.feed.entry.length,title:response.feed.title.$t};onSuccess(info)}})}getSpreadsheetInfo(spreadsheetKey,function(info){loadSheets(spreadsheetKey,info)})},Sheet.prototype.header=function(){return this.rows[0].values()},Sheet.prototype.value=function(row,colName){var colIndex=this.header().indexOf(colName);if(-1==colIndex)return null;var result=null;return $.each(row.rowCells,function(i,rowCell){return rowCell.colIndex==colIndex?(result=rowCell.value,!1):void 0}),result},Row.prototype.values=function(){return $.map(this.rowCells,function(rowCell,i){return rowCell.value})}},{}]},{},[1])(1)});
