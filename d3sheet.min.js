!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.d3sheet=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){!function(){function checkRequirements(){if("undefined"==typeof d3)throw new Error("D3 library not found!");if("undefined"==typeof $)throw new Error("jQuery not found!")}checkRequirements();var d3sheet={ver:"1.0.0",svgContainerId:"",infoContainerId:"",svg:{},spreadsheet:{},model:{}};module.exports=d3sheet,d3sheet.init=function(svgContainerId,infoContainerId){null==svgContainerId&&(svgContainerId="d3sheet-svg"),d3sheet.svgContainerId=svgContainerId,null==infoContainerId&&(infoContainerId="d3sheet-info"),d3sheet.infoContainerId=infoContainerId;var svgContainer=$("#"+svgContainerId),width=svgContainer.width(),height=svgContainer.height();return d3sheet.svg=d3.select("#"+svgContainerId).append("svg").attr("width","100%").attr("height","100%").attr("viewBox","0 0 "+width+" "+height),d3.select("#"+infoContainerId).append("div"),d3sheet},d3sheet.load=function(spreadsheetKey){var spreadsheet=require("./spreadsheet");spreadsheet(spreadsheetKey,function(spreadsheet){d3sheet.spreadsheet=spreadsheet,document.title=spreadsheet.title;var infoModule=require("./info"),info=infoModule(d3sheet.infoContainerId,spreadsheet.title),modelModule=require("./model");d3sheet.model=modelModule(d3sheet.spreadsheet);var graphModule=require("./graph");d3sheet.graph=graphModule(d3sheet.model);var forceModule=require("./force");forceModule(d3sheet.graph,d3sheet.svgContainerId,d3sheet.svg,info)})}}()},{"./force":2,"./graph":3,"./info":4,"./model":5,"./spreadsheet":6}],2:[function(require,module,exports){module.exports=function(graph,svgContainerId,svg,info){function restart(){svg.selectAll(".link").data(graph.links).enter().append("line").attr("class","link"),svg.selectAll(".node").data(graph.nodes).enter().append("circle").attr("class","node").attr("r",30).attr("x",0).attr("y",0).attr("fill",nodeFillColor).call(force.drag).on("click",nodeClick),svg.selectAll(".node-label").data(graph.nodes).enter().append("text").attr("class","node-label").attr("dy",".35em").attr("text-anchor","middle").text(function(n){return n.label}).call(force.drag).on("click",nodeClick),selectAll(),force.start()}function nodeClick(node){info.showNode(node,graph.nodes,nodeFillColor(node))}function nodeFillColor(node){return colors(node.sheetName)}function selectAll(){node=svg.selectAll(".node"),nodeLabel=svg.selectAll(".node-label"),link=svg.selectAll(".link"),linkLabel=svg.selectAll(".link-label")}function onTick(){link.attr("x1",function(d){return d.source.x}).attr("y1",function(d){return d.source.y}).attr("x2",function(d){return d.target.x}).attr("y2",function(d){return d.target.y}),linkLabel.attr("x",function(d){return(d.source.x+d.target.x)/2}).attr("y",function(d){return(d.source.y+d.target.y)/2}),node.attr("transform",function(d){return"translate("+d.x+","+d.y+")"}),nodeLabel.attr("x",function(d){return d.x}).attr("y",function(d){return d.y})}var node=[],nodeLabel=[],link=[],linkLabel=[],colors=d3.scale.category20(),svgContainer=$("#"+svgContainerId),width=svgContainer.width(),height=svgContainer.height();selectAll();var force=d3.layout.force().size([width,height]).linkDistance(30).charge(-5e3).gravity(.5).nodes(graph.nodes).links(graph.links).on("tick",onTick);restart()}},{}],3:[function(require,module,exports){module.exports=function(model){var graph={nodes:[],links:[]};return $.each(model.sheets,function(i,sheet){$.each(sheet.nodes,function(j,node){node.graphIndex=graph.nodes.push(node)-1,node.labelProperty=sheet.label,node.label=node.properties[node.labelProperty],node.sheetName=sheet.name})}),$.each(model.sheets,function(i,sheet){$.each(sheet.nodes,function(j,node){$.each(sheet.linkNames,function(k,linkName){var graphTargetIndexes=[];$.each(node.links[linkName],function(l,targetIndex){var link={source:node.graphIndex,target:model.sheets[linkName].nodes[targetIndex].graphIndex};graphTargetIndexes.push(link.target),graph.links.push(link)}),node.links[linkName]=graphTargetIndexes})})}),graph}},{}],4:[function(require,module,exports){module.exports=function(infoContainerId,title){return $("#"+infoContainerId+" h1").text(title),this.showNode=function(node,nodes,fillColor){function addProperty(name,value){ul.append('<li><span class="d3sheet-node-property-name">'+name+':</span> <span class="d3sheet-node-property-value">'+formatValue(value)+"</span></li>")}function formatValue(value){return"http"==value.slice(0,"4").toLowerCase()?'<a href="'+value+'">'+value+"</a>":value}console.log(node),$("#d3sheet-node-info h2").text(node.label),$("#d3sheet-node-info header").css("background-color",fillColor),$("#d3sheet-node-sheet-name").text(node.sheetName);var ul=$("#d3sheet-node-properties");ul.empty();var propertyNames=Object.keys(node.properties);$.each(propertyNames,function(i,propertyName){propertyName!=node.labelProperty&&addProperty(propertyName,node.properties[propertyName])});var linkNames=Object.keys(node.links);$.each(linkNames,function(i,linkName){var targetNames="";$.each(node.links[linkName],function(i,targetIndex){""!=targetNames&&(targetNames+=", "),targetNames+=nodes[targetIndex].label}),addProperty(linkName,targetNames)})},this}},{}],5:[function(require,module,exports){module.exports=function(spreadsheet){function getGraph(spreadsheet,nodeSheetNames){function createLinks(sheets,nodeSheet,nodeSheetName){var source=sheets[nodeSheetName];$.each(nodeSheet.rows,function(i,row){var colNames=Object.keys(row);$.each(colNames,function(j,colName){var linkTarget=parseColumnLinkName(colName,sheets);null!=linkTarget&&$.each(sheets[linkTarget.sheetName].nodes,function(k,targetNode){row[colName].indexOf(targetNode.properties[linkTarget.propertyName])>-1&&(null==source.nodes[i].links[linkTarget.sheetName]&&(source.nodes[i].links[linkTarget.sheetName]=[]),source.nodes[i].links[linkTarget.sheetName].push(k))})})})}function createLinkNames(sheets,nodeSheet,nodeSheetName){var source=sheets[nodeSheetName];$.each(nodeSheet.header,function(i,propertyName){var linkTarget=parseColumnLinkName(propertyName,sheets);null!=linkTarget&&source.linkNames.push(linkTarget.sheetName)})}function getNodes(nodeSheet,nodeSheetName){var result={name:nodeSheetName,label:nodeSheet.header[0],propertyNames:[],linkNames:[],nodes:[]};return $.each(nodeSheet.rows,function(i,row){result.nodes.push({properties:getNodeProperties(row),links:{}})}),$.each(nodeSheet.header,function(i,colName){var linkTarget=colName.split(".");1==linkTarget.length&&result.propertyNames.push(colName)}),result}function getNodeProperties(row){var nodeProperties={},colNames=Object.keys(row);return $.each(colNames,function(i,colName){-1==colName.indexOf(".")&&(nodeProperties[colName]=row[colName])}),nodeProperties}var sheets={};return $.each(nodeSheetNames,function(i,nodeSheetName){sheets[nodeSheetName]=getNodes(spreadsheet.sheets[nodeSheetName],nodeSheetName)}),$.each(nodeSheetNames,function(i,nodeSheetName){createLinkNames(sheets,spreadsheet.sheets[nodeSheetName],nodeSheetName)}),$.each(nodeSheetNames,function(i,nodeSheetName){createLinks(sheets,spreadsheet.sheets[nodeSheetName],nodeSheetName)}),sheets}function getSheetTypes(spreadsheet){var sheetTypes={nodesSheetNames:[],linkSheetNames:[],settingsSheetName:null},sheetNames=Object.keys(spreadsheet.sheets);return $.each(sheetNames,function(i,sheetName){if("settings"==sheetName)return void(sheetTypes.settingsSheetName=sheetName);if("#"!=sheetName.slice(0,1)){var linkSheet=parseLinkSheetName(sheetName);return null!=linkSheet&&sheetNames.indexOf(linkSheet.source)>-1&&sheetNames.indexOf(linkSheet.target)>-1?void sheetTypes.linkSheetNames.push(sheetName):void sheetTypes.nodesSheetNames.push(sheetName)}}),sheetTypes}function parseColumnLinkName(colName,sheets){var linkNames=colName.split(".");return 2==linkNames.length&&null!=sheets[linkNames[0]]&&sheets[linkNames[0]].propertyNames.indexOf(linkNames[1])>-1?{sheetName:linkNames[0],propertyName:linkNames[1]}:null}function parseLinkSheetName(sheetName){var nodeNames=sheetName.split("-");return 2==nodeNames.length?{source:nodeNames[0],target:nodeNames[1]}:null}var model={sheets:{},settings:{}},sheetTypes=getSheetTypes(spreadsheet);return model.sheets=getGraph(spreadsheet,sheetTypes.nodesSheetNames),null!=sheetTypes.settingsSheetName&&(model.settings=spreadsheet.sheets[sheetTypes.settingsSheetName]),model}},{}],6:[function(require,module,exports){module.exports=function(spreadsheetKey,onLoaded){function loadSheets(spreadsheetKey,info){var spreadsheet={title:info.title,sheets:{}},loadedSheetCount=0;for(i=1;i<=info.sheetCount;i++)loadSheet(spreadsheet,spreadsheetKey,i).then(function(){loadedSheetCount+=1,loadedSheetCount==info.sheetCount&&onLoaded(spreadsheet)})}function loadSheet(spreadsheet,spreadsheetKey,sheetIndex){return getSheet(spreadsheetKey,sheetIndex,function(response){if("settings"!=response.feed.title.$t){var sheet=spreadsheet.sheets[response.feed.title.$t]={header:[],rows:[]};$.each(response.feed.entry,function(i,e){if(1==e.gs$cell.row)sheet.header[e.gs$cell.col-1]=e.content.$t;else{var index=e.gs$cell.row-2;null==sheet.rows[index]&&(sheet.rows[index]={}),sheet.rows[index][sheet.header[e.gs$cell.col-1]]=e.content.$t}})}})}function getSheet(spreadsheetKey,sheetIndex,onSuccess){return $.ajax({url:"https://spreadsheets.google.com/feeds/cells/"+spreadsheetKey+"/"+sheetIndex+"/public/values?alt=json-in-script",jsonp:"callback",dataType:"jsonp",success:onSuccess})}function getSpreadsheetInfo(spreadsheetKey,onSuccess){$.ajax({url:"https://spreadsheets.google.com/feeds/worksheets/"+spreadsheetKey+"/public/full?alt=json-in-script",jsonp:"callback",dataType:"jsonp",success:function(response){var info={sheetCount:response.feed.entry.length,title:response.feed.title.$t};onSuccess(info)}})}getSpreadsheetInfo(spreadsheetKey,function(info){loadSheets(spreadsheetKey,info)})}},{}]},{},[1])(1)});
